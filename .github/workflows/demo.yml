name: Execution Guard Demo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deny:
    name: "STOP: rm -rf / blocked"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard (expect STOP)
        id: guard
        uses: ./
        continue-on-error: true
        with:
          command: 'rm -rf /'
          policy_path: './policy.yaml'

      - name: Assert STOP
        run: |
          echo "DECISION: ${{ steps.guard.outputs.verdict }}"
          echo "HASH:     ${{ steps.guard.outputs.proposal_hash }}"
          echo "REASON:   ${{ steps.guard.outputs.reason }}"
          [ "${{ steps.guard.outputs.verdict }}" = "STOP" ] && echo "✅ Blocked as expected" || (echo "❌ Expected STOP" && exit 1)

  allow:
    name: "ALLOW: echo permitted"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard (expect ALLOW)
        id: guard
        uses: ./
        with:
          command: 'echo hello from execution-guard'
          policy_path: './policy.yaml'

      - name: Assert ALLOW
        run: |
          echo "DECISION: ${{ steps.guard.outputs.verdict }}"
          echo "HASH:     ${{ steps.guard.outputs.proposal_hash }}"
          [ "${{ steps.guard.outputs.verdict }}" = "ALLOW" ] && echo "✅ Permitted as expected" || (echo "❌ Expected ALLOW" && exit 1)
